
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>6.1. Neural network: Back propagation &#8212; Machine Learning Notes - 2022 Fall</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.2. Example" href="example.html" />
    <link rel="prev" title="6. Introduction" href="intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Machine Learning Notes - 2022 Fall</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../references.html">
                    References
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter1/intro.html">
   1. Introduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter1/what.html">
     1.1. What is Machine Learning?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter1/data.html">
     1.2. Basic setting for Machine learning problems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter1/pynotebook.html">
     1.3. Python quick guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter1/project.html">
     1.4. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter2/intro.html">
   2. k-NN
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter2/knn.html">
     2.1. k-Nearest Neighbors Algorithm (k-NN)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter2/knnproj1.html">
     2.2. k-NN Project 1:
     <code class="docutils literal notranslate">
      <span class="pre">
       iris
      </span>
     </code>
     Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter2/knnproj2.html">
     2.3. k-NN Project 2: Dating Classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter2/knnproj3.html">
     2.4. k-NN Project 3:
     <code class="docutils literal notranslate">
      <span class="pre">
       MNIST
      </span>
     </code>
     Handwritten recognition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter2/project.html">
     2.5. Exercises and Projects
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter3/intro.html">
   3. Decision Tree
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter3/gini.html">
     3.1. Gini impurity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter3/code.html">
     3.2. CART Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter3/dt.html">
     3.3. Decision Tree Project 1: the
     <code class="docutils literal notranslate">
      <span class="pre">
       iris
      </span>
     </code>
     dataset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter3/dt2.html">
     3.4. Decision Tree Project 2:
     <code class="docutils literal notranslate">
      <span class="pre">
       make_moons
      </span>
     </code>
     dataset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter3/project.html">
     3.5. Exercises and Projects
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter4/intro.html">
   4. Ensemble methods
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter4/morevoting.html">
     4.1. Voting machine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter4/randomforest.html">
     4.2. Bootstrap aggregating
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter4/adaboost.html">
     4.3.
     <code class="docutils literal notranslate">
      <span class="pre">
       AdaBoost
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter4/project.html">
     4.4. Exercises and Projects
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter5/intro.html">
   5. Logistic Regression
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter5/regression.html">
     5.1. Basic idea
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter5/regularization.html">
     5.2. Regularization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter5/nn.html">
     5.3. Neural network implement of Logistic regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter5/multi.html">
     5.4. Multi class case
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter5/project.html">
     5.5. Exercises and Projects
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="intro.html">
   6. Neural Network
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     6.1. Neural network: Back propagation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="example.html">
     6.2. Example
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="project.html">
     6.3. Exercises and Projects
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ChapterApp/intro.html">
   7. Appendix
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ChapterApp/datasets.html">
     7.1. Datasets
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Chapter6/nn.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Neural network: Back propagation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="neural-network-back-propagation">
<h1><span class="section-number">6.1. </span>Neural network: Back propagation<a class="headerlink" href="#neural-network-back-propagation" title="Permalink to this headline">#</a></h1>
<div class="math notranslate nohighlight">
\[\newcommand\diffp[2]{\dfrac{\partial #1}{\partial #2}}\]</div>
<p>To train a MLP model, we still use gradient descent. Therefore it is very important to know how to compute the gradient. Actually the idea is the same as logistic regreesion. The only issue is that now the model is more complicated. The gradient computation is summrized as an algorithm called <code class="docutils literal notranslate"><span class="pre">back</span> <span class="pre">propagation</span></code>. It is described as follows.</p>
<p>Here is an example of a Neural network with one hidden layer.</p>
<p><img alt="" src="../_images/20221114232327.png" /></p>
<p><span class="math notranslate nohighlight">\(\Theta\)</span> is the coefficients of the whole Neural network.</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(a^{(1)}=\hat{\textbf{x}}\)</span> is the input. <span class="math notranslate nohighlight">\(a_0^{(1)}\)</span> is added. This is an <span class="math notranslate nohighlight">\((n+1)\)</span>-dimension column vector.</p></li>
<li><p><span class="math notranslate nohighlight">\(\Theta^{(1)}\)</span> is the coefficient matrix from the input layer to the hidden layer, of size <span class="math notranslate nohighlight">\(k\times(n+1)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(2)}=\Theta^{(1)}a^{(1)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(a^{(2)}=\sigma(z^{(2)})\)</span>, and then add <span class="math notranslate nohighlight">\(a^{(2)}_0\)</span>. This is an <span class="math notranslate nohighlight">\((k+1)\)</span>-dimension column vector.</p></li>
<li><p><span class="math notranslate nohighlight">\(\Theta^{(2)}\)</span> is the coefficient matrix from the hidden layer to the output layer, of size <span class="math notranslate nohighlight">\(r\times(k+1)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(3)}=\Theta^{(2)}a^{(2)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(a^{(3)}=\sigma(z^{(3)})\)</span>. Since this is the output layer, <span class="math notranslate nohighlight">\(a^{(3)}_0\)</span> won’t be added.</p>
</li>
</ul>
<p>The dependency is as follows:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(J\)</span> depends on <span class="math notranslate nohighlight">\(z^{(3)}\)</span> and <span class="math notranslate nohighlight">\(a^{(3)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(3)}\)</span> and <span class="math notranslate nohighlight">\(a^{(3)}\)</span> depends on <span class="math notranslate nohighlight">\(\Theta^{(2)}\)</span> and <span class="math notranslate nohighlight">\(a^{(2)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(2)}\)</span> and <span class="math notranslate nohighlight">\(a^{(2)}\)</span> depends on <span class="math notranslate nohighlight">\(\Theta^{(1)}\)</span> and <span class="math notranslate nohighlight">\(a^{(1)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(J\)</span> depends on <span class="math notranslate nohighlight">\(\Theta^{(1)}\)</span>, <span class="math notranslate nohighlight">\(\Theta^{(2)}\)</span> and <span class="math notranslate nohighlight">\(a^{(1)}\)</span>.</p></li>
</ul>
<p>Each layer is represented by the following diagram:</p>
<p><img alt="" src="../_images/20221114232354.png" /></p>
<p>The diagram says:</p>
<div class="math notranslate nohighlight">
\[
z^{(k+1)}=b^{(k)}+\Theta^{(k)}a^{(k)},\quad z^{(k+1)}_j=b^{(k)}_j+\sum \Theta^{(k)}_{jl}a^{(k)}_l,\quad a^{(k)}_j=\sigma(z^{(k)}_j).
\]</div>
<p>Assume <span class="math notranslate nohighlight">\(r,j\geq1\)</span>. Then</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\diffp{z^{(k+1)}_i}{a^{(k)}_r}&amp;=\diffp{\left(b^{(k)}_i+\sum\Theta^{(k)}_{il}a^{(k)}_l\right)}{a^{(k)}_r}=\Theta_{ir}^{(k)},\\
% \diffp{z^{(k+1)}_i}{\Theta^{(k)}_{ij}}&amp;=\diffp*{\qty(a^{(k)}_0+\sum\Theta^{(k)}_{il}a^{(k)}_l)}{\Theta^{(k)}_{ij}}=a^{(k)}_j,\\
\diffp{z^{(k+1)}_i}{z^{(k)}_j}&amp;=\sum_r \diffp{z^{(k+1)}_i}{a^{k}_r}\diffp{a^{(k)}_r}{z^{(k)}_j}+\sum_{p,g}\diffp{z^{(k+1)}_i}{\Theta^{(k)}_{pq}}\diffp{\Theta^{(k)}_{pq}}{z^{(k)}_j}+\sum_r \diffp{z^{(k+1)}_i}{b^{k}_r}\diffp{b^{(k)}_r}{z^{(k)}_j}\\
&amp;=\sum_r \Theta^{(k)}_{ir}\diffp{a^{(k)}_r}{z^{(k)}_j}=\Theta^{(k)}_{ij}\diffp{a^{(k)}_j}{z^{(k)}_j}=\Theta^{(k)}_{ij}\sigma'(z^{(k)}_j),\\
\diffp{J}{z^{(k)}_j}&amp;=\sum_r \diffp{J}{z^{(k+1)}_r}\diffp{z^{(k+1)}_r}{z^{(k)}_j}=\sum_r\diffp{J}{z^{(k+1)}_r}\Theta^{(k)}_{rj}\sigma'(z^{(k)}_j).
\end{aligned}
\end{split}\]</div>
<p>We set</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\delta^k_j=\diffp{J}{z^{(k)}_j}\)</span>, <span class="math notranslate nohighlight">\(\delta^k=\left[\delta^k_1,\delta_2^k,\ldots\right]^T\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{z}^k=\left[z^{(k)}_1,z^{(k)}_2,\ldots\right]^T\)</span>, <span class="math notranslate nohighlight">\(\mathbf{a}^k=\left[a^{(k)}_1,a^{(k)}_2,\ldots\right]^T\)</span>,
<span class="math notranslate nohighlight">\(\hat{\mathbf{a}}^k=\left[a^{(k)}_0,a^{(k)}_1,\ldots\right]^T\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\Theta^{k}=\left[\Theta^{(k)}_{ij}\right]\)</span>.</p></li>
</ul>
<p>Then we have the following formula. Note that there are ``<span class="math notranslate nohighlight">\(z_0\)</span>’’ terms.</p>
<div class="math notranslate nohighlight">
\[
    \delta^k=\left[(\Theta^k)^T\delta^{k+1}\right]\circ \sigma'(\mathbf{z}^k).
\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\diffp{z^{(k+1)}_r}{\Theta^{(k)}_{pq}}&amp;=\diffp{\left(b^{(k)}_r+\sum_l\Theta^{(k)}_{rl}a^{(k)}_l\right)}{\Theta^{(k)}_{pq}}=\begin{cases}
0&amp;\text{ for }r\neq q,\\
a^{(k)}_q&amp;\text{ for }r=q,
\end{cases}\\
\diffp{J}{\Theta^{(k)}_{pq}}&amp;=\sum_{r}\diffp{J}{z^{(k+1)}_r}\diffp{z^{(k+1)}_r}{\Theta^{(k)}_{pq}}=\diffp{J}{z^{(k+1)}_p}\diffp{z^{(k+1)}_p}{\Theta^{(k)}_{pq}}=\delta^{k+1}_pa^{k}_q,\\
\diffp{J}{b^{(k)}_{j}}&amp;=\sum_{r}\diffp{J}{z^{(k+1)}_r}\diffp{z^{(k+1)}_r}{b^{(k)}_{j}}=\diffp{J}{z^{(k+1)}_j}\diffp{z^{(k+1)}_j}{b^{(k)}_{j}}=\diffp{J}{z^{(k+1)}_j}=\delta^{k+1}_j.
\end{aligned}
\end{split}\]</div>
<p>Extend <span class="math notranslate nohighlight">\(\hat{\Theta}=\left[b^{(k)},\Theta^{(k)}\right]\)</span>, and <span class="math notranslate nohighlight">\(\partial^k J=\left[\diffp{J}{\hat{\Theta}^{(k)}_{ij}}\right]\)</span>. Then
$<span class="math notranslate nohighlight">\(
    \partial^k J=\left[\delta^{k+1}, \delta^{k+1}(\mathbf{a}^k)^T\right].
\)</span>$
Then the algorithm is as follows.</p>
<ol class="simple">
<li><p>Starting from <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and some random <span class="math notranslate nohighlight">\(\Theta\)</span>.</p></li>
<li><p>Forward computation: compute <span class="math notranslate nohighlight">\(z^{(k)}\)</span> and <span class="math notranslate nohighlight">\(a^{(k)}\)</span>. The last <span class="math notranslate nohighlight">\(a^{(n)}\)</span> is <span class="math notranslate nohighlight">\(h\)</span>.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\delta^n=\nabla J\circ\sigma'(z^{(n)})\)</span>. In the case of <span class="math notranslate nohighlight">\(J=\frac12||{h-y}||^2\)</span>, <span class="math notranslate nohighlight">\(\nabla J=(a^{(n)}-y)\)</span>, and then <span class="math notranslate nohighlight">\(\delta^n=(a^{(n)}-y)\circ\sigma'(z^{(n)})\)</span>.</p></li>
<li><p>Backwards: <span class="math notranslate nohighlight">\(\delta^k=\left[(\Theta^k)^T\delta^{k+1}\right]\circ \sigma'(\mathbf{z}^k)\)</span>, and <span class="math notranslate nohighlight">\(\partial^k J=\left[\delta^{k+1}, \delta^{k+1}(\mathbf{a}^k)^T\right]\)</span> .</p></li>
</ol>
<div class="proof example admonition" id="example-0">
<p class="admonition-title"><span class="caption-number">Example 6.1 </span></p>
<section class="example-content" id="proof-content">
<p>Consider there are 3 layers: input, hidden and output. There are <span class="math notranslate nohighlight">\(m+1\)</span> nodes in the input layer, <span class="math notranslate nohighlight">\(n+1\)</span> nodes in the hidden layer and <span class="math notranslate nohighlight">\(k\)</span> in the output layer. Therefore</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(a^{(1)}\)</span> and <span class="math notranslate nohighlight">\(\delta^1\)</span> are <span class="math notranslate nohighlight">\(m\)</span>-dim column vectors.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(2)}\)</span>, <span class="math notranslate nohighlight">\(a^{(2)}\)</span> and <span class="math notranslate nohighlight">\(\delta^2\)</span> are <span class="math notranslate nohighlight">\(n\)</span>-dim column vectors.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(3)}\)</span>, <span class="math notranslate nohighlight">\(a^{(3)}\)</span> and <span class="math notranslate nohighlight">\(\delta^3\)</span> are <span class="math notranslate nohighlight">\(k\)</span>-dim column vectors.</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat{\Theta}^1\)</span> is <span class="math notranslate nohighlight">\(n\times(m+1)\)</span>, <span class="math notranslate nohighlight">\(\hat{\Theta}^2\)</span> is <span class="math notranslate nohighlight">\(k\times(n+1)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(z^{(2)}=b^{(1)}+\Theta^{(1)}a^{(1)}=\hat{\Theta}^{(1)}\hat{a}^{(1)}\)</span>, <span class="math notranslate nohighlight">\(z^{(3)}=b^{(2)}+\Theta^{(2)}a^{(2)}=\hat{\Theta}^{(2)}\hat{a}^{(2)}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\delta^3=\nabla_aJ\circ\sigma'(z^{(3)})\)</span>. This is a <span class="math notranslate nohighlight">\(k\)</span>-dim column vector.</p></li>
<li><p><span class="math notranslate nohighlight">\(\partial^2 J=\left[\delta^3,\delta^3(a^{(2)})^T\right]\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\delta^2=\left[(\Theta^2)^T\delta^3\right]\circ \sigma'(z^{(2)})\)</span>, where <span class="math notranslate nohighlight">\((\hat{\Theta^2})^T\delta^3=(\hat{\Theta^2})^T\delta^3\)</span> and then remove the first row.</p>
</li>
<li><p><span class="math notranslate nohighlight">\(\partial^1 J=\left[\delta^2,\delta^2(a^{(1)})^T\right]\)</span>.</p></li>
<li><p>When <span class="math notranslate nohighlight">\(J=-\frac1m\sum y\ln a+(1-y)\ln(1-a)\)</span>, <span class="math notranslate nohighlight">\(\delta^3=\frac1m(\sum a^{(3)}-\sum y)\)</span>.</p></li>
</ul>
</section>
</div></section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">6. </span>Introduction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="example.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6.2. </span>Example</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Xinli Xiao<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>